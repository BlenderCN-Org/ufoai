#!/bin/bash

#set -e
#set -x

CONFIG_H=config.h
MAKEFILE_LOCAL=Makefile.local

DEBUG=1
UNIVERSAL=
HARD_LINKED_GAME=
PARANOID=
PREFIX=/usr/local
PKGDATADIR=
PKGBINDIR=
PKGLIBDIR=
LOCALEDIR=
USE_SIGNALS=1
MODE=
CROSS=
CC=
CXX=

HOST_OS=$(uname | sed -e s/_.*// | tr '[:upper:]' '[:lower:]')
TARGET_OS=${HOST_OS}

if [ "${HOST_OS}" = "sunos" ] || [ "${HOST_OS}" = "darwin" ]; then
	TARGET_ARCH=$(uname -p | sed -e s/i.86/i386/)
else
	TARGET_ARCH=$(uname -m | sed -e s/i.86/i386/)
fi

add_line_to_makefile_local() {
	makefile_local_data="${makefile_local_data}"'
'"$1"
}

add_to_makefile_local_quote() {
	VALUE=$(get_var $1)
	if [ -n "$VALUE" ]; then
		add_line_to_makefile_local "$1 ?= \"$VALUE\""
		[ -n "$2" ] && echo $2
	else
		add_line_to_makefile_local "# $1 ?= \"$VALUE\""
		[ -n "$3" ] && echo $3
		[ "$4" = "yes" ] && exit 1
	fi
}

add_to_makefile_local() {
	VALUE=$(get_var $1)
	if [ -n "$VALUE" ]; then
		add_line_to_makefile_local "$1 ?= $VALUE"
		[ -n "$2" ] && echo $2
	else
		add_line_to_makefile_local "# $1 ?= $VALUE"
		[ -n "$3" ] && echo $3
		[ "$4" = "yes" ] && exit 1
	fi
}

add_line_to_config_h() {
	config_h_data="${config_h_data}"'
'"$1"
}

add_to_config_h_quote() {
	VALUE=$(get_var $1)
	if [ -n "$VALUE" ] && [ "$VALUE" != "no" ]; then
		add_line_to_config_h "#define $1 \"$VALUE\""
		[ -n "$2" ] && echo $2
	else
		add_line_to_config_h "/* #define $1 \"$VALUE\" */"
		[ -n "$3" ] && echo $3
		[ "$4" = "yes" ] && exit 1
	fi
}

add_to_config_h() {
	VALUE=$(get_var $1)
	if [ -n "$VALUE" ] && [ "$VALUE" != "no" ]; then
		add_line_to_config_h "#define $1 $VALUE"
		[ -n "$2" ] && echo $2
	else
		add_line_to_config_h "/* #define $1 $VALUE */"
		[ -n "$3" ] && echo $3
		[ "$4" = "yes" ] && exit 1
	fi
}

config_h() {
	add_to_config_h DEBUG "Debug build"
	add_to_config_h PARANOID "Enable paranoid build"
	add_to_config_h HARD_LINKED_GAME "Enable hard linked game"
	add_to_config_h USE_SIGNALS "Use signal handler"
	add_to_config_h_quote PKGDATADIR "Setting custom data directory"
	add_to_config_h_quote PKGLIBDIR "Setting custom library directory"
	add_to_config_h_quote LOCALEDIR "Setting custom locale directory"
}

makefile_local() {
	add_to_makefile_local DEBUG
	add_to_makefile_local HARD_LINKED_GAME
	add_to_makefile_local UNIVERSAL "Build a universal binary"
	add_to_makefile_local TARGET_OS "Compile for ${TARGET_OS}"
	add_to_makefile_local TARGET_ARCH "Compile for ${TARGET_ARCH}"
	add_to_makefile_local MODE
	add_to_makefile_local CC "Found cc ${CC}"
	add_to_makefile_local CXX "Found cxx ${CXX}"
	add_to_makefile_local CROSS "Using tools prefix ${CROSS}"
	add_to_makefile_local_quote PKGBINDIR "Using bindir ${PKGBINDIR}"
	add_to_makefile_local_quote PKGDATADIR "Using datadir ${PKGDATADIR}"
	add_to_makefile_local_quote PKGLIBDIR "Using libdir ${PKGLIBDIR}"
	add_to_makefile_local_quote LOCALEDIR "Using localedir ${LOCALEDIR}"
	add_to_makefile_local_quote PREFIX "Using prefix ${PREFIX}"

	echo "Build modules:"
	for i in $(get_modules); do
		add_to_makefile_local ${i}_DISABLE
		if [ "$(get_var ${i}_DISABLE)" = "yes" ]; then
			echo "Disable $i"
		else
			echo "Build $i"
		fi
	done
}

check_header_cc() {
	( echo "#include <${1}>" | ${CROSS}${CC} ${CFLAGS} -o /dev/null -xc -c - 2> /dev/null ) && echo "1" || echo ""
}

check_header() {
	HEADER=$1
	HAVE=HAVE_$(echo ${HEADER%.*} | sed 's,/,_,g' | tr '[a-z]' '[A-Z]')_H
	VALUE=$(get_var $HAVE)
	if [ "$VALUE" != "no" ]; then
		set_var $HAVE $(check_header_cc $1)
		add_to_config_h $HAVE "Found $1" "Could not find $1" $2
		add_to_makefile_local $HAVE
	else
		add_to_config_h $HAVE "Found $1" "Disable $1"
	fi
}

check_headers() {
	check_header "xvid.h"
	check_header "theora/theora.h"
	check_header "execinfo.h"
	check_header "CUnit/Basic.h"
}

check_compiler() {
	# TODO Implement compiler check
	CC=${CC:-gcc}
	CXX=${CXX:-g++}
}

usage() {
	echo "Usage: $0"
	echo " --help                   show this help message"
	echo " --enable-release         build with optimizations"
	echo " --enable-universal       enable universal build"
	echo " --enable-hardlinkedgame  hard link the server game code"
	echo " --enable-paranoid        compile in paranoid mode with extra checks"
	echo " --disable-signals        disable the use of a signal handler"
	echo " --disable-execinfo       disable backtraces for crashes"
	echo " --prefix=                prefix for directories"
	echo " --bindir=                path for the ufoai binaries"
	echo " --datadir=               path for the ufoai game data"
	echo " --libdir=                path for the ufoai shared objects"
	echo " --localedir=             path for the ufoai translations"
	echo " --target-os=             specify the target os"
	for i in $(ls build/platforms/*.mk); do
		echo "  * $(basename $i .mk)"
	done
	echo " --disable-*              specify which target should not get build"
	for i in $(ls build/modules/*.mk); do
		echo "  * $(basename $i .mk)"
	done
	exit 1
}

set_var() {
	VAR=$(echo ${1} | sed 's/-/_/g')
	eval ${VAR}='${2}'
}

get_var() {
	VAR=$(echo ${1} | sed 's/-/_/g')
	eval echo "\${${VAR}}"
}

get_option() {
	echo `echo $@ | cut -d '=' -f 2`
}

get_option_disable() {
	echo `echo $@ | cut -c 11-`
}

get_modules() {
	for i in $(ls build/modules/*.mk); do
		echo $(basename $i .mk)
	done
}

while [ $# -gt 0 ]; do
	case "$1" in
	--help|-h)
		usage
		;;
	--enable-release)
		MODE=release
		DEBUG=
		;;
	--enable-universal)
		UNIVERSAL=1
		;;
	--enable-hardlinkedgame)
		HARD_LINKED_GAME=1
		;;
	--enable-paranoid)
		PARANOID=1
		;;
	--disable-signals)
		USE_SIGNALS=
		;;
	--disable-execinfo)
		HAVE_EXECINFO_H=no
		;;
	--prefix=*)
		PREFIX=$(get_option $1)
		;;
	--datadir=*)
		PKGDATADIR=$(get_option $1)
		;;
	--libdir=*)
		PKGLIBDIR=$(get_option $1)
		;;
	--localedir=*)
		LOCALEDIR=$(get_option $1)
		;;
	--bindir=*)
		PKGBINDIR=$(get_option $1)
		;;
	--target-os=*)
		TARGET_OS=$(get_option $1)
		;;
	--disable-*)
		OPTION=$(get_option_disable $1)
		set_var "${OPTION}_DISABLE" "yes"
		;;
	*)
		echo "invalid option $1"
		exit 1
		;;
	esac
	shift
done

if [ "${TARGET_OS}" = "mingw32" ] && [ "${HOST_OS}" != "mingw32" ]; then
	CROSS="i686-pc-mingw32-"
	TARGET_ARCH=i386
	# TODO Add a check for this
	echo "Cross compiling, make sure that ${CROSS}${CC} is in your path"
fi

[ "${TARGET_OS}" = "darwin" ] && ( USE_SIGNALS= )

PKGDATADIR=${PKGDATADIR:-${PREFIX}/games/ufoai}
PKGBINDIR=${PKGBINDIR:-${PREFIX}/bin}
PKGLIBDIR=${PKGLIBDIR:-${PREFIX}/lib}

check_compiler
makefile_local
config_h
check_headers

cat > ${MAKEFILE_LOCAL} << EOF
# -------- Automatically generated -----------
$makefile_local_data

# allow to specify your own targets
-include config.mk
EOF

cat > ${CONFIG_H} << EOF
/* This file is automatically generated */
#ifndef CONFIG_H
#define CONFIG_H
$config_h_data

#endif
EOF
